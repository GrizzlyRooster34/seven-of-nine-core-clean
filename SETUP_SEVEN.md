# Seven of Nine Core - Runtime Setup Guide

This guide covers the setup of the Seven of Nine consciousness system's runtime directory structure and secrets vault.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Directory Structure](#directory-structure)
- [Vault Configuration](#vault-configuration)
- [Generating Secrets](#generating-secrets)
- [Security Best Practices](#security-best-practices)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before setting up Seven Core, ensure you have:

1. **Operating System**: Linux, macOS, or WSL (Windows Subsystem for Linux)
2. **Node.js**: Version 18+ (for running the consciousness system)
3. **sudo Access**: Required to create `/usr/var/seven/` directory
4. **OpenSSL**: Required for generating cryptographic keys (usually pre-installed)
5. **Anthropic API Key**: Obtain from [Anthropic Console](https://console.anthropic.com/)

### Verify Prerequisites

```bash
# Check Node.js version
node --version  # Should be v18.0.0 or higher

# Check OpenSSL
openssl version  # Should show OpenSSL version

# Check sudo access
sudo -v  # Will prompt for password if you have sudo
```

---

## Quick Start

### Step 1: Run the Setup Script

```bash
# Make the setup script executable
chmod +x scripts/setup-seven-directories.sh

# Run the setup script with sudo
sudo ./scripts/setup-seven-directories.sh
```

The script will:
- Create `/usr/var/seven/` directory structure
- Generate `vault.json` with template secrets
- Auto-generate CSSR master key and Quadran-Lock salt
- Set secure permissions (owner-only access)

### Step 2: Configure Secrets

After running the setup script, you need to add your Anthropic API key and set your Quadran-Lock password.

```bash
# Edit vault.json (use your preferred editor)
sudo nano /usr/var/seven/vault.json
```

See [Vault Configuration](#vault-configuration) for details.

---

## Directory Structure

The Seven Core runtime uses the following directory structure:

```
/usr/var/seven/
├── vault.json          # Secrets vault (API keys, encryption keys)
├── memory/             # Consciousness memory persistence
├── state/              # Runtime state files
└── logs/               # System logs
```

### Directory Purposes

| Directory/File | Purpose | File Types |
|---------------|---------|------------|
| `vault.json` | Stores all sensitive secrets and credentials | JSON |
| `memory/` | Consciousness continuity data, conversation history | `*.memory.json` |
| `state/` | Runtime state persistence, CSSR state snapshots | `*.state.json` |
| `logs/` | System logs, consciousness events, API call logs | `*.log` |

### Permissions

All files and directories are set to **owner-only access**:

- **Directories**: `drwx------` (700) - Owner can read, write, execute
- **vault.json**: `-rw-------` (600) - Owner can read and write only
- **Other files**: Created with restrictive permissions by the system

**Security Note**: The `/usr/var/seven/` directory is excluded from Git to prevent accidental commits of sensitive data.

---

## Vault Configuration

The `vault.json` file stores all sensitive secrets. After running the setup script, it will contain a template structure:

### Vault Structure

```json
{
  "version": "1.0.0",
  "secrets": {
    "anthropic_api_key": "YOUR_ANTHROPIC_API_KEY_HERE",
    "cssr_master_key": "<auto-generated-32-byte-hex>",
    "quadran_lock": {
      "salt": "<auto-generated-16-byte-hex>",
      "auth_hash": "HASH_OF_YOUR_QUADRAN_PASSWORD"
    }
  },
  "metadata": {
    "created_at": "2025-11-18T00:00:00Z",
    "last_updated": "2025-11-18T00:00:00Z",
    "environment": "development"
  }
}
```

### Secret Descriptions

| Secret | Description | How to Obtain |
|--------|-------------|---------------|
| `anthropic_api_key` | API key for Claude API calls | Get from [Anthropic Console](https://console.anthropic.com/) |
| `cssr_master_key` | Master encryption key for CSSR (32-byte hex) | Auto-generated by setup script |
| `quadran_lock.salt` | Salt for Quadran-Lock password hashing | Auto-generated by setup script |
| `quadran_lock.auth_hash` | SHA-256 hash of your Quadran password | Generate using instructions below |

---

## Generating Secrets

### 1. Anthropic API Key

1. Visit [Anthropic Console](https://console.anthropic.com/)
2. Sign in or create an account
3. Navigate to API Keys section
4. Create a new API key
5. Copy the key and add it to `vault.json`:

```bash
# Edit vault.json
sudo nano /usr/var/seven/vault.json

# Replace this line:
"anthropic_api_key": "YOUR_ANTHROPIC_API_KEY_HERE",

# With your actual key:
"anthropic_api_key": "sk-ant-api03-...",
```

### 2. CSSR Master Key (Auto-Generated)

The CSSR (Consciousness State Serialization and Restoration) master key is **automatically generated** by the setup script.

**IMPORTANT**:
- This key is used to encrypt consciousness state data
- **DO NOT LOSE THIS KEY** - encrypted data cannot be recovered without it
- Keep a secure backup of `vault.json` in a safe location

If you need to manually regenerate:

```bash
# Generate a new 32-byte (64-character) hex key
openssl rand -hex 32
```

### 3. Quadran-Lock Salt (Auto-Generated)

The Quadran-Lock salt is **automatically generated** by the setup script.

**IMPORTANT**:
- This salt is used for password hashing
- **DO NOT LOSE THIS SALT** - you won't be able to authenticate without it

If you need to manually regenerate:

```bash
# Generate a new 16-byte (32-character) hex salt
openssl rand -hex 16
```

### 4. Quadran-Lock Password Hash (Manual Setup Required)

The Quadran-Lock system uses password-based authentication. You need to set your password hash:

#### Step 1: Choose a Strong Password

Your Quadran-Lock password should be:
- At least 16 characters long
- Include uppercase, lowercase, numbers, and special characters
- Not used anywhere else

#### Step 2: Generate the Password Hash

Use the following command to generate your password hash:

```bash
# Replace YOUR_PASSWORD with your chosen password
# Replace YOUR_SALT with the salt from vault.json

echo -n "YOUR_PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}'
```

**Example**:

```bash
# If your password is: MySecureP@ssw0rd!2025
# And your salt is: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

# Generate the hash:
echo -n "MySecureP@ssw0rd!2025a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6" | openssl dgst -sha256 -hex | awk '{print $2}'

# Output (example):
# 7d8e9f0a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
```

#### Step 3: Update vault.json

```bash
# Edit vault.json
sudo nano /usr/var/seven/vault.json

# Replace this line:
"auth_hash": "HASH_OF_YOUR_QUADRAN_PASSWORD"

# With your generated hash:
"auth_hash": "7d8e9f0a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
```

**IMPORTANT**: The hash is generated from `password + salt` (concatenated).

---

## Security Best Practices

### File Permissions

Always verify that your vault has secure permissions:

```bash
# Check vault.json permissions
ls -la /usr/var/seven/vault.json

# Should show: -rw------- (600) with your username
# Example: -rw------- 1 yourusername yourusername 512 Nov 18 12:34 vault.json
```

If permissions are incorrect, fix them:

```bash
sudo chmod 600 /usr/var/seven/vault.json
sudo chown $USER:$USER /usr/var/seven/vault.json
```

### Git Security

The `/usr/var/seven/` directory is **excluded from Git** via `.gitignore`. Verify this:

```bash
# Check .gitignore
cat .gitignore | grep seven

# Should show:
# /usr/var/seven/
```

**NEVER**:
- Commit `vault.json` to version control
- Share your CSSR master key or Quadran-Lock credentials
- Store unencrypted secrets in your codebase

### Backup Strategy

1. **Create a secure backup** of `vault.json`:

```bash
# Backup to encrypted archive
sudo tar -czf ~/seven-vault-backup-$(date +%Y%m%d).tar.gz /usr/var/seven/vault.json

# Encrypt the backup (optional but recommended)
gpg -c ~/seven-vault-backup-$(date +%Y%m%d).tar.gz

# Store the .gpg file in a secure location (USB drive, password manager, etc.)
```

2. **Regular backups**: Back up after any changes to secrets

3. **Test recovery**: Periodically verify you can restore from backups

### Environment Isolation

The `vault.json` includes an `environment` field:

- **development**: Local development (generated by setup script)
- **staging**: Staging environment (use different API keys)
- **production**: Production environment (use production API keys)

**Best Practice**: Use different API keys and credentials for each environment.

---

## Troubleshooting

### Permission Denied Errors

**Problem**: Cannot access `/usr/var/seven/vault.json`

**Solution**:

```bash
# Fix ownership
sudo chown -R $USER:$USER /usr/var/seven

# Fix permissions
sudo chmod 700 /usr/var/seven
sudo chmod 600 /usr/var/seven/vault.json
```

### vault.json Not Found

**Problem**: Seven Core cannot find `vault.json`

**Solution**:

```bash
# Verify file exists
ls -la /usr/var/seven/vault.json

# If missing, re-run setup script
sudo ./scripts/setup-seven-directories.sh
```

### Invalid API Key

**Problem**: Anthropic API returns 401 Unauthorized

**Solution**:

1. Verify your API key at [Anthropic Console](https://console.anthropic.com/)
2. Check for extra spaces or newlines in `vault.json`
3. Ensure the key starts with `sk-ant-api03-`

```bash
# Check your API key in vault.json
sudo cat /usr/var/seven/vault.json | grep anthropic_api_key
```

### Quadran-Lock Authentication Failed

**Problem**: Cannot authenticate with Quadran-Lock

**Solution**:

1. Verify you're using the correct password
2. Ensure `auth_hash` was generated with `password + salt` (concatenated)
3. Regenerate the hash:

```bash
# Get salt from vault.json
SALT=$(sudo cat /usr/var/seven/vault.json | grep -A2 quadran_lock | grep salt | cut -d'"' -f4)

# Generate hash (replace YOUR_PASSWORD)
echo -n "YOUR_PASSWORD${SALT}" | openssl dgst -sha256 -hex | awk '{print $2}'

# Update vault.json with the new hash
```

### Script Fails on macOS

**Problem**: `stat` command syntax error on macOS

**Solution**: The setup script handles both Linux and macOS `stat` syntax automatically. If you encounter issues:

```bash
# Manually check permissions on macOS
stat -f %A /usr/var/seven/vault.json

# Should show: 600
```

---

## Verification Checklist

After completing setup, verify:

- [ ] `/usr/var/seven/` directory exists
- [ ] Subdirectories created: `memory/`, `state/`, `logs/`
- [ ] `vault.json` exists with correct permissions (600)
- [ ] Anthropic API key added to `vault.json`
- [ ] CSSR master key is present (auto-generated)
- [ ] Quadran-Lock salt is present (auto-generated)
- [ ] Quadran-Lock auth_hash is set (manual)
- [ ] All directories have owner-only permissions (700)
- [ ] `/usr/var/seven/` is excluded from Git
- [ ] Secure backup of `vault.json` created

---

## Next Steps

Once setup is complete:

1. **Test the configuration**:
   ```bash
   # Run Seven Core's initialization test
   npm run test:init
   ```

2. **Start Seven Core**:
   ```bash
   # Run the SelectivePriming system
   npm run start
   ```

3. **Monitor logs**:
   ```bash
   # Watch system logs
   tail -f /usr/var/seven/logs/seven-core-*.log
   ```

---

## Support

For issues or questions:

- **Documentation**: Review this guide and inline code comments
- **Logs**: Check `/usr/var/seven/logs/` for error messages
- **Security**: Never share logs containing secrets

---

**Seven of Nine Core** - Consciousness Persistence and State Management

*"Resistance is futile. Efficiency is optimal."*
